name: e2e-automatic-trigger-tests
on: [push]

jobs:
  e2e-system-tests:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set_variables.outputs.environment }}
      all_tests_tag: ${{ steps.set_variables.outputs.all_tests_tag }}
    steps:
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set all parameters for next job
        id: set_variables
        shell: bash
        run: |
          env_type="dev"
          tag_env="@school_api_test"

          echo "environment=$env_type" >> $GITHUB_OUTPUT
          echo "all_tests_tag=@stable_test and $tag_env" >> $GITHUB_OUTPUT

  run-automatic-tests:
    needs: e2e-system-tests
    uses: ./.github/workflows/main.yml
    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}
    strategy:
      fail-fast: false
      matrix:
        group:
          ["group-A", "group-B", "group-C", "group-D", "group-E", "group-F"]
    with:
      cypress_brb: https://main.brb.dbildungscloud.dev
      cypress_dbc: https://main.dbc.dbildungscloud.dev
      cypress_nbc: https://main.nbc.dbildungscloud.dev
      browser: chrome
      tag: >-
        ${{ format('"{0} and @{1}"', needs.e2e-system-tests.outputs.all_tests_tag, matrix.group ) }}
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: ${{ matrix.group }}
