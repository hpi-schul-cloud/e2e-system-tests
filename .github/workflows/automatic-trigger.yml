name: e2e-automatic-trigger-tests
on: [push]

jobs:
  e2e-system-tests:
    runs-on: ubuntu-latest
    outputs:
      instance1: ${{ steps.set_vars.outputs.instance1 }}
      instance2: ${{ steps.set_vars.outputs.instance2 }}
      instance3: ${{ steps.set_vars.outputs.instance3 }}
      environment: ${{ steps.set_vars.outputs.environment }}

    steps:
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Checkout
        uses: actions/checkout@v4

      - id: set_vars
        run: |
          echo "instance1=https://main.brb.dbildungscloud.dev" >> $GITHUB_OUTPUT
          echo "instance2=https://main.nbc.dbildungscloud.dev" >> $GITHUB_OUTPUT
          echo "instance3=https://main.dbc.dbildungscloud.dev" >> $GITHUB_OUTPUT

          if [[ ! "https://main.brb.dbildungscloud.dev" =~ (staging|schulportal) && ! "https://main.nbc.dbildungscloud.dev" =~ (staging|schulportal) && ! "https://main.dbc.dbildungscloud.dev" =~ (staging|schulportal) ]]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
          else
            echo "environment=ref" >> $GITHUB_OUTPUT
          fi

  # Helper YAML anchors for DRYness
  # Not strictly necessary but neat

  run-tests-groupA:
    needs: e2e-system-tests
    uses: ./.github/workflows/main.yml
    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}
    with:
      cypress_brb: ${{ needs.e2e-system-tests.outputs.instance1 }}
      cypress_nbc: ${{ needs.e2e-system-tests.outputs.instance2 }}
      cypress_dbc: ${{ needs.e2e-system-tests.outputs.instance3 }}
      tag: cy:headless:stable:groupA:school_api_test:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: group-A

  run-tests-groupB:
    needs: e2e-system-tests
    uses: ./.github/workflows/main.yml
    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}
    with:
      cypress_brb: ${{ needs.e2e-system-tests.outputs.instance1 }}
      cypress_nbc: ${{ needs.e2e-system-tests.outputs.instance2 }}
      cypress_dbc: ${{ needs.e2e-system-tests.outputs.instance3 }}
      tag: cy:headless:stable:groupB:school_api_test:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: group-B

  run-tests-groupC:
    needs: e2e-system-tests
    uses: ./.github/workflows/main.yml
    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}
    with:
      cypress_brb: ${{ needs.e2e-system-tests.outputs.instance1 }}
      cypress_nbc: ${{ needs.e2e-system-tests.outputs.instance2 }}
      cypress_dbc: ${{ needs.e2e-system-tests.outputs.instance3 }}
      tag: cy:headless:stable:groupC:school_api_test:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: group-C

  run-tests-groupD:
    needs: e2e-system-tests
    uses: ./.github/workflows/main.yml
    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}
    with:
      cypress_brb: ${{ needs.e2e-system-tests.outputs.instance1 }}
      cypress_nbc: ${{ needs.e2e-system-tests.outputs.instance2 }}
      cypress_dbc: ${{ needs.e2e-system-tests.outputs.instance3 }}
      tag: cy:headless:stable:groupD:school_api_test:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: group-D

  run-tests-groupE:
    needs: e2e-system-tests
    uses: ./.github/workflows/main.yml
    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}
    with:
      cypress_brb: ${{ needs.e2e-system-tests.outputs.instance1 }}
      cypress_nbc: ${{ needs.e2e-system-tests.outputs.instance2 }}
      cypress_dbc: ${{ needs.e2e-system-tests.outputs.instance3 }}
      tag: cy:headless:stable:groupE:school_api_test:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: group-E

  run-tests-groupF:
    needs: e2e-system-tests
    uses: ./.github/workflows/main.yml
    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}
    with:
      cypress_brb: ${{ needs.e2e-system-tests.outputs.instance1 }}
      cypress_nbc: ${{ needs.e2e-system-tests.outputs.instance2 }}
      cypress_dbc: ${{ needs.e2e-system-tests.outputs.instance3 }}
      tag: cy:headless:stable:groupF:school_api_test:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: group-F

  run-tests-groupG:
    needs: e2e-system-tests
    uses: ./.github/workflows/main.yml
    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}
    with:
      cypress_brb: ${{ needs.e2e-system-tests.outputs.instance1 }}
      cypress_nbc: ${{ needs.e2e-system-tests.outputs.instance2 }}
      cypress_dbc: ${{ needs.e2e-system-tests.outputs.instance3 }}
      tag: cy:headless:stable:groupG:school_api_test:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: group-G

  run-tests-groupH:
    needs: e2e-system-tests
    uses: ./.github/workflows/main.yml
    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}
    with:
      cypress_brb: ${{ needs.e2e-system-tests.outputs.instance1 }}
      cypress_nbc: ${{ needs.e2e-system-tests.outputs.instance2 }}
      cypress_dbc: ${{ needs.e2e-system-tests.outputs.instance3 }}
      tag: cy:headless:stable:groupH:school_api_test:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: group-H

  run-tests-groupI:
    needs: e2e-system-tests
    uses: ./.github/workflows/main.yml
    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}
    with:
      cypress_brb: ${{ needs.e2e-system-tests.outputs.instance1 }}
      cypress_nbc: ${{ needs.e2e-system-tests.outputs.instance2 }}
      cypress_dbc: ${{ needs.e2e-system-tests.outputs.instance3 }}
      tag: cy:headless:stable:groupI:school_api_test:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: group-I

  run-tests-groupJ:
    needs: e2e-system-tests
    uses: ./.github/workflows/main.yml
    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}
    with:
      cypress_brb: ${{ needs.e2e-system-tests.outputs.instance1 }}
      cypress_nbc: ${{ needs.e2e-system-tests.outputs.instance2 }}
      cypress_dbc: ${{ needs.e2e-system-tests.outputs.instance3 }}
      tag: cy:headless:stable:groupJ:school_api_test:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: group-J

  run-tests-groupK:
    needs: e2e-system-tests
    uses: ./.github/workflows/main.yml
    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}
    with:
      cypress_brb: ${{ needs.e2e-system-tests.outputs.instance1 }}
      cypress_nbc: ${{ needs.e2e-system-tests.outputs.instance2 }}
      cypress_dbc: ${{ needs.e2e-system-tests.outputs.instance3 }}
      tag: cy:headless:stable:groupK:school_api_test:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: group-K

  run-tests-groupL:
    needs: e2e-system-tests
    uses: ./.github/workflows/main.yml
    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}
    with:
      cypress_brb: ${{ needs.e2e-system-tests.outputs.instance1 }}
      cypress_nbc: ${{ needs.e2e-system-tests.outputs.instance2 }}
      cypress_dbc: ${{ needs.e2e-system-tests.outputs.instance3 }}
      tag: cy:headless:stable:groupL:school_api_test:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: group-L

  run-tests-groupM:
    needs: e2e-system-tests
    uses: ./.github/workflows/main.yml
    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}
    with:
      cypress_brb: ${{ needs.e2e-system-tests.outputs.instance1 }}
      cypress_nbc: ${{ needs.e2e-system-tests.outputs.instance2 }}
      cypress_dbc: ${{ needs.e2e-system-tests.outputs.instance3 }}
      tag: cy:headless:stable:groupM:school_api_test:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: group-M

  run-tests-groupN:
    needs: e2e-system-tests
    uses: ./.github/workflows/main.yml
    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}
    with:
      cypress_brb: ${{ needs.e2e-system-tests.outputs.instance1 }}
      cypress_nbc: ${{ needs.e2e-system-tests.outputs.instance2 }}
      cypress_dbc: ${{ needs.e2e-system-tests.outputs.instance3 }}
      tag: cy:headless:stable:groupN:school_api_test:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: group-N

  run-tests-groupO:
    needs: e2e-system-tests
    uses: ./.github/workflows/main.yml
    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}
    with:
      cypress_brb: ${{ needs.e2e-system-tests.outputs.instance1 }}
      cypress_nbc: ${{ needs.e2e-system-tests.outputs.instance2 }}
      cypress_dbc: ${{ needs.e2e-system-tests.outputs.instance3 }}
      tag: cy:headless:stable:groupO:school_api_test:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: group-O

  run-tests-groupP:
    needs: e2e-system-tests
    uses: ./.github/workflows/main.yml
    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}
    with:
      cypress_brb: ${{ needs.e2e-system-tests.outputs.instance1 }}
      cypress_nbc: ${{ needs.e2e-system-tests.outputs.instance2 }}
      cypress_dbc: ${{ needs.e2e-system-tests.outputs.instance3 }}
      tag: cy:headless:stable:groupP:school_api_test:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: group-P

  run-tests-groupQ:
    needs: e2e-system-tests
    uses: ./.github/workflows/main.yml
    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}
    with:
      cypress_brb: ${{ needs.e2e-system-tests.outputs.instance1 }}
      cypress_nbc: ${{ needs.e2e-system-tests.outputs.instance2 }}
      cypress_dbc: ${{ needs.e2e-system-tests.outputs.instance3 }}
      tag: cy:headless:stable:groupQ:school_api_test:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: group-Q

  run-tests-groupR:
    needs: e2e-system-tests
    uses: ./.github/workflows/main.yml
    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}
    with:
      cypress_brb: ${{ needs.e2e-system-tests.outputs.instance1 }}
      cypress_nbc: ${{ needs.e2e-system-tests.outputs.instance2 }}
      cypress_dbc: ${{ needs.e2e-system-tests.outputs.instance3 }}
      tag: cy:headless:stable:groupR:school_api_test:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: group-R

  run-tests-groupS:
    needs: e2e-system-tests
    uses: ./.github/workflows/main.yml
    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}
    with:
      cypress_brb: ${{ needs.e2e-system-tests.outputs.instance1 }}
      cypress_nbc: ${{ needs.e2e-system-tests.outputs.instance2 }}
      cypress_dbc: ${{ needs.e2e-system-tests.outputs.instance3 }}
      tag: cy:headless:stable:groupS:school_api_test:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: group-S

  run-tests-groupT:
    needs: e2e-system-tests
    uses: ./.github/workflows/main.yml
    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}
    with:
      cypress_brb: ${{ needs.e2e-system-tests.outputs.instance1 }}
      cypress_nbc: ${{ needs.e2e-system-tests.outputs.instance2 }}
      cypress_dbc: ${{ needs.e2e-system-tests.outputs.instance3 }}
      tag: cy:headless:stable:groupT:school_api_test:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: group-T
