name: e2e-manual-trigger-tests
on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: "Select test mode"
        required: true
        type: choice
        options:
          - all (stable, regression tests)
          - selective (runs on PR)
          - pre-check (used for pre-check release)
        default: "selective (runs on PR)"
      instance1:
        description: "Please enter a valid BRB instance URL to run the tests on"
        default: "https://main.brb.dbildungscloud.dev"
        required: true
      instance2:
        description: "Please enter a valid NBC instance URL to run the tests on"
        default: "https://main.nbc.dbildungscloud.dev"
        required: true
      instance3:
        description: "Please enter a valid DBC instance URL to run the tests on"
        default: "https://main.dbc.dbildungscloud.dev"
        required: true

jobs:
  e2e-system-tests:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set_variables.outputs.environment }}

    steps:
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set all parameters for next job
        id: set_variables
        shell: bash
        run: |

          if [[ ! ${{ inputs.instance1 }} =~ (staging|schulportal) && ! ${{ inputs.instance2 }} =~ (staging|schulportal) && ! ${{ inputs.instance3 }} =~ (staging|schulportal) ]]; then
              echo "environment=dev" >> $GITHUB_OUTPUT
          else
              echo "environment=ref" >> $GITHUB_OUTPUT
          fi

  run-all-tests:
    name: Run All Tests (Stable + Regression)
    needs: e2e-system-tests
    if: ${{ inputs.test_mode == 'all (stable, regression tests)' }}
    uses: ./.github/workflows/main.yml
    with:
      cypress_brb: ${{ inputs.instance1 }}
      cypress_dbc: ${{ inputs.instance3 }}
      cypress_nbc: ${{ inputs.instance2 }}
      tag: cy:headless:stable:regression_test:school_api_test:manual_trigger:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: manual-trigger

    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}

  run-tests-selective:
    name: Run Tests Run in PR
    needs: e2e-system-tests
    if: ${{ inputs.test_mode == 'selective (runs on PR)' }}
    uses: ./.github/workflows/main.yml
    strategy:
      fail-fast: false
      matrix:
        group: [group-A, group-B, group-C, group-D, group-E, group-F]
    with:
      cypress_brb: ${{ inputs.instance1 }}
      cypress_dbc: ${{ inputs.instance3 }}
      cypress_nbc: ${{ inputs.instance2 }}
      tag: cy:headless:stable:${{ matrix.group }}:school_api_test:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: ${{ matrix.group }}
    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}

  run-pre-check-tests:
    name: Run All Pre-Check Tests
    needs: e2e-system-tests
    if: ${{ inputs.test_mode == 'pre-check (used for pre-check release)' }}
    uses: ./.github/workflows/main.yml
    with:
      cypress_brb: ${{ inputs.instance1 }}
      cypress_dbc: ${{ inputs.instance3 }}
      cypress_nbc: ${{ inputs.instance2 }}
      tag: cy:headless:stable:regression_test:school_api_test:manual_trigger:pre_check:ci
      environment: ${{ needs.e2e-system-tests.outputs.environment }}
      groups: pre-check

    secrets:
      service-account-token: ${{ secrets.CYPRESS_ONEPWD_SERVICE_ACCOUNT_TOKEN }}

  # notify_RC:
  #   runs-on: ubuntu-latest
  #   needs:
  #     - e2e-system-tests
  #     - run-all-tests
  #     - run-tests-selective
  #     - run-pre-check-tests
  #   if: |
  #     always()

  #   steps:
  #     - uses: technote-space/workflow-conclusion-action@v3

  #     - name: Send Notification to Rocket Chat
  #       uses: RocketChat/Rocket.Chat.GitHub.Action.Notification@1.1.1
  #       with:
  #         type: ${{ env.WORKFLOW_CONCLUSION }}
  #         job_name: "Cypress Tests"
  #         url: ${{ secrets.RC_WEBHOOK_URL }}
  #         username: Manual Trigger Test Run
